apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config         # Name used by Deployment to mount this config
  namespace: prod
data:
  nginx.conf: |              # Entire nginx.conf contents here
    worker_processes 1;
    events { worker_connections 1024; }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      sendfile        on;
      keepalive_timeout 65;

      server {
        listen 80;
        server_name _;

        # Static file serving
        root /usr/share/nginx/html;
        index index.html;

        location / {
          try_files $uri $uri/ =404;
        }

        # Reverse-proxy any /api/ calls to the backend service
        location /api/ {
          proxy_pass         http://backend-service:80;
          proxy_set_header   Host             $host;
          proxy_set_header   X-Real-IP        $remote_addr;
          proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }
      }
    }