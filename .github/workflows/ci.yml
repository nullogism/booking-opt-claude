name: CI - Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # =============================================================
  # LINT AND TYPE CHECK
  # =============================================================
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy

      - name: Run ruff (linting)
        run: ruff check app/

      - name: Run black (formatting check)
        run: black --check app/

      - name: Run mypy (type checking)
        run: mypy app/api app/worker || true  # Allow to fail for now
        continue-on-error: true

  # =============================================================
  # UNIT TESTS
  # =============================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/api/requirements.txt
          pip install -r app/tests/requirements.txt

      - name: Run unit tests
        run: pytest app/tests/test_api.py -v --tb=short

  # =============================================================
  # BUILD DOCKER IMAGES
  # =============================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./app/api
          file: ./app/api/Dockerfile
          push: false
          tags: bookingopt-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Worker image
        uses: docker/build-push-action@v5
        with:
          context: ./app/worker
          file: ./app/worker/Dockerfile
          push: false
          tags: bookingopt-worker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================
  # INTEGRATION TESTS
  # =============================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/tests/requirements.txt

      - name: Start services with Docker Compose
        run: |
          cd hotel-optimizer-infra
          docker compose up -d
          sleep 30  # Wait for services to be ready

      - name: Check service health
        run: |
          curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost/health

      - name: Run integration tests
        run: pytest app/tests/test_integration.py -v -m integration

      - name: View logs on failure
        if: failure()
        run: |
          cd hotel-optimizer-infra
          docker compose logs

      - name: Stop services
        if: always()
        run: |
          cd hotel-optimizer-infra
          docker compose down -v

  # =============================================================
  # SECURITY SCANNING
  # =============================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run dependency check
        run: |
          pip install safety
          safety check --file app/api/requirements.txt || true
          safety check --file app/worker/requirements.txt || true
        continue-on-error: true

  # =============================================================
  # SUMMARY
  # =============================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, build, integration-tests, security]
    if: success()

    steps:
      - name: Success message
        run: echo "âœ… All CI checks passed!"
